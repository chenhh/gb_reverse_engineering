# 加殼與脫殼

## 甚麼是殼呢？

軟體脫殼，顧名思義，就是對軟體加殼的逆操作，把軟體上存在的殼去掉。

在一些軟體里也有一段專門負責保護軟體不被非法修改或反編譯的程式。它們一般都是先於程式運行，拿到控制權，然後完成它們保護軟體的任務。由於這段程式和自然界的殼在功能上有很多相同的地方，基於命名的規則，大家就把這樣的程式稱為"殼"了。

## 殼的用途？

一般而言，殼會在軟體被載入後先執行，來對原本的程式碼解密或還原，解殼後才會進入到原本程式真正要開始執行的地方（Orginal Entry Point；OEP）。

由於是在被載入執行後才進行還原，如此便能夠增加反編譯的困難，防止程式過於容易被靜態分析後破解或修改。加殼的目的包括了合法軟體對版權的保護以及電腦病毒防止被分析。

一開始，殼是以對程式加密保護，防止被破解為目的。但是對於病毒的＂開發者們＂而言，為病毒加殼也就讓防毒分析變得難以＂破解＂。當然，許多防毒公司對於大眾化的，商用化的殼都有一定的解殼之道，所以由強大的駭客們自製的私有殼也就層出不窮。

對於小而精巧的 DOS 檔而言，對程式加密的確很重要。但對體積較大的 exe 檔而言，壓縮也成為了一個重要的需求。依據需求的不同，從原本單純的加密殼，也就發展到了壓縮殼。

我們可以利用一些簡單的工具來幫我們判斷程式是否加殼，像是PEiD、Exeinfo PE 等等。

## 常見的殼

### 壓縮殼

壓縮殼的目的就是讓軟體的體積減小。需要提供一定的兼容性及穩定性，確保壓縮後的檔案能在不同的平台解壓縮，且能夠正確解壓縮回原檔案。

### UPX

UPX 是一個以 command line 方式操作的免費壓縮軟體，使用一種叫做 UCL 的壓縮算法。UCL 最大的好處就是在壓縮及解壓縮的過程中不需要額外的內存，UPX 目有 DOS、Linux 以及 Windows 版本。

### WinRAR

是僅有的幾個可以讀寫 RAR 檔案的軟體之一。它能夠進行資料修復，自訂壓縮後分割檔，設定密碼等。他使用進階加密標準 AES 進行 128 位元加密。AES 的好處在於在他只需要很少的記憶體便能實作加密，而且其安全性達到保護機密資訊的標準。所以如果對一個有設定密碼的 RAR 壓縮檔想進行破解幾乎是不可能的。

### 加密殼

不同的加密殼能達到的效果也不太相同。有些加密殼單純是為了防止程式遭到反編譯破解，也有另一些加密殼提供程式的註冊，使用次數以及時間限制。

### ASProtect

同時擁有壓縮，加密，CRC 校正等保護措施。他使用了許多效力強大的加密演算法以確保程式保密性，若開發者想要使用註冊機制，他也提供了 RSA 1024 作為註冊的 key generator。在其加殼過程中也可以加入開發者自己寫的 DLL 來增加程式被反編譯的困難度。

### Armadillo

是一款應用面很廣的商業殼，可以為程式加上使用時間，次數以及啟動畫面等設定，他的保護功能其中一項稱為 Nanomite。

Nanomite 技術能夠標記某些程式區段，將這些區段做混淆並寫入記憶體中。對於原本應該是這些程式碼所在的地方則改為 jump。在壓縮前殼再將這些 jump 改為 int 3（op code 為 0xCC）的程式中斷點並紀錄這些標記。如此達到加密與隱蔽性的目的，因此 Nanomite 也被稱為 CC 保護。

Import table Elimination 也是 Armadillo 使用的技術之一。 由於分析師能夠依據程式 import table 裡的 APIs 猜測到這隻程式的意圖，破壞原本程式的 import table 就能夠增加反編譯的困難。這項技術在私有殼中也十分常見。

### 私有殼

病毒開發者們為了應付防毒公司對其病毒的追殺，自然而然就產生出了保護病毒的私有殼。簡單的殼例如使用一個 key 以及一種運算（如 and、or、xor、add 等）對主要程式碼處的 byte ／ word ／ dword 作修改，如此一來即使將程式載入 IDA 也因為程式碼被殼修改過而無法順利解析，需要以人工方式或動態工具執行後才能看到原本程式碼的內容。

複雜的殼甚至可以在殼中加殼，第一階段殼解析完後的程式碼帶有部分原本要執行的程式碼以及另一階段殼。要產生出複雜的私有殼，對病毒開發者而言必定是會花不少心力，但對病毒公司而言反編譯並解析出原本的程式碼所需投入的時間也跟著增加。







